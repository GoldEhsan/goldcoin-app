<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>GoldCoin App</title>
    
    <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>

    <style>
        /* All CSS styles are correct and remain the same */
        :root {
            --color-bg: #111827;
            --color-card: #1f2937;
            --color-card-light: #374151;
            --color-text: #ffffff;
            --color-text-muted: #9ca3af;
            --color-primary: #facc15; /* yellow-400 */
            --color-primary-dark: #f59e0b; /* yellow-500 */
            --color-secondary: #3b82f6; /* blue-500 */
            --color-green: #22c55e; /* green-500 */
            --color-red: #ef4444; /* red-500 */
        }
        body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background-color: var(--color-bg); color: var(--color-text); }
        #root { display: flex; flex-direction: column; min-height: 100vh; }
        .app-container { flex-grow: 1; max-width: 512px; margin: 0 auto; padding: 0.75rem; width: 100%; box-sizing: border-box; }
        .header { background-color: var(--color-card); border-radius: 0.75rem; padding: 0.75rem; margin-bottom: 1rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); display: flex; justify-content: space-between; align-items: center; }
        .header-left { flex-grow: 1; }
        .header-title { font-size: 1.25rem; font-weight: 700; color: var(--color-primary); }
        .header-subtitle { font-size: 0.75rem; color: var(--color-text-muted); margin-top: 0.25rem; }
        .balance-display { display: flex; align-items: center; justify-content: flex-end; }
        .balance-icon { width: 1.25rem; height: 1.25rem; color: var(--color-primary); margin-right: 0.25rem; }
        .balance-amount { font-size: 1.125rem; font-weight: 700; }
        .card { background-color: var(--color-card); border-radius: 1rem; padding: 1.5rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); }
        .section-title { font-size: 1.5rem; font-weight: 700; color: var(--color-primary); margin-bottom: 1.5rem; text-align: center; }
        .button { width: 100%; padding: 0.75rem 1rem; font-weight: 700; border-radius: 0.5rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); transition: all 0.2s; border: none; cursor: pointer; }
        .button:active { transform: scale(0.95); }
        .button:disabled { background-color: #4b5563; cursor: not-allowed; }
        .button-primary { background-color: var(--color-primary-dark); color: var(--color-card); }
        .button-primary:hover:not(:disabled) { background-color: var(--color-primary); }
        .button-secondary { background-color: var(--color-secondary); color: white; }
        .button-green { background-color: var(--color-green); color: white; }
        .button-small { padding: 0.5rem 1rem; font-size: 0.875rem; width: auto; flex-shrink: 0; }
        .button-link { background: none; box-shadow: none; color: var(--color-text-muted); width: auto; margin-top: 1rem; }
        .button-done { padding: 0.5rem 1rem; font-size: 0.875rem; font-weight: 700; background-color: #16a34a; color: white; border-radius: 0.5rem; }
        .spin-wheel-container { position: relative; width: 280px; height: 280px; margin: 2rem auto; }
        .spin-wheel { position: absolute; inset: 0; transition: transform 4000ms cubic-bezier(0.25, 0.1, 0.25, 1); }
        .spin-pointer { position: absolute; top: -4px; left: 50%; transform: translateX(-50%); width: 0; height: 0; border-left: 12px solid transparent; border-right: 12px solid transparent; border-bottom: 20px solid var(--color-red); z-index: 10; }
        .spin-result { margin-top: 1rem; padding: 0.75rem; background-color: var(--color-card-light); border-radius: 0.5rem; font-size: 1.125rem; }
        .spin-result-value { font-weight: 700; color: var(--color-primary); }
        .wheel-svg-text { font-size: 18px; font-weight: bold; fill: white; text-anchor: middle; dominant-baseline: middle; }
        .item-list { display: flex; flex-direction: column; gap: 0.75rem; }
        .list-item { padding: 1rem; border-radius: 0.5rem; display: flex; justify-content: space-between; align-items: center; background-color: var(--color-card-light); }
        .list-item-content { display: flex; align-items: center; flex-grow: 1; min-width: 0; }
        .list-item-icon { font-size: 1.5rem; margin-right: 1rem; flex-shrink: 0; }
        .list-item-details { flex-grow: 1; }
        .list-item-title { font-weight: 600; }
        .list-item-subtitle { font-size: 0.875rem; color: var(--color-primary); }
        .list-item-completed { opacity: 0.6; }
        .info-box { background-color: var(--color-card-light); padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem; text-align: center; }
        .info-box p { margin: 0; line-height: 1.5; }
        .invite-link-box { background-color: var(--color-bg); padding: 0.75rem; border-radius: 0.5rem; display: flex; justify-content: space-between; align-items: center; margin: 1rem 0; }
        .invite-link-text { color: var(--color-green); font-family: monospace; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .footer-spacer { height: 5rem; }
        .footer { position: fixed; bottom: 0; left: 0; right: 0; background-color: var(--color-card); border-top: 1px solid var(--color-card-light); }
        .nav { max-width: 512px; margin: 0 auto; display: flex; justify-content: space-around; }
        .nav-button { flex: 1; display: flex; flex-direction: column; align-items: center; padding: 0.5rem 0.25rem; text-align: center; color: var(--color-text-muted); transition: color 0.2s; background: none; border: none; cursor: pointer; }
        .nav-button:hover { color: var(--color-green); }
        .nav-button-active { color: var(--color-primary); }
        .nav-icon { width: 1.75rem; height: 1.75rem; }
        .nav-label { font-size: 0.75rem; margin-top: 0.25rem; }
        .game-viewer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: #000; z-index: 1000; display: flex; flex-direction: column; }
        .game-viewer-header { padding: 0.5rem; background-color: #1f2937; display: flex; justify-content: flex-end; flex-shrink: 0; }
        .game-viewer-iframe { flex-grow: 1; border: none; }
        .header-right { display: flex; align-items: center; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script type="text/babel">
        const { useState, useEffect, useCallback, useMemo } = React;
        const TonConnectUI = window.TonConnectUI.TonConnectUI; // Get constructor from global window object

        // --- All other components and hooks are the same ---
        const useTelegram = () => { /* ... */ 
            const [tg, setTg] = useState(null);
            useEffect(() => {
                if (window.Telegram && window.Telegram.WebApp) {
                    const telegramApp = window.Telegram.WebApp;
                    telegramApp.ready();
                    telegramApp.expand();
                    setTg(telegramApp);
                }
            }, []);
            return tg;
        };
        const Icon = ({ name, className }) => { /* ... */
            const iconSvgs = { 'coin': <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-8.707l-3-3a1 1 0 00-1.414 0l-3 3a1 1 0 001.414 1.414L9 9.414V13a1 1 0 102 0V9.414l1.293 1.293a1 1 0 001.414-1.414z" clipRule="evenodd" /></svg>, 'spinner': <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>, 'game': <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M11 4a2 2 0 114 0v1a1 1 0 001 1h3a1 1 0 011 1v3a1 1 0 01-1 1h-1a2 2 0 100 4h1a1 1 0 011 1v3a1 1 0 01-1 1h-3a1 1 0 01-1-1v-1a2 2 0 10-4 0v1a1 1 0 01-1 1H7a1 1 0 01-1-1v-3a1 1 0 00-1-1H4a2 2 0 110-4h1a1 1 0 001-1V7a1 1 0 011-1h3a1 1 0 001-1V4z" /></svg>, 'task': <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" /></svg>, 'wallet': <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" /></svg>, 'friends': <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M15 21a6 6 0 00-9-5.197M15 11a4 4 0 110-5.292" /></svg>, };
            const element = iconSvgs[name]; if (!element) return null; return React.cloneElement(element, { className });
        };
        const DailySpin = ({ spins, setSpins, updateBalance, tg }) => { /* ... */ 
            const segments = useMemo(() => [ { label: '10', value: 10 }, { label: 'MISS', value: 0 }, { label: '20', value: 20 }, { label: '5', value: 5 }, { label: '50', value: 50 }, { label: 'MISS', value: 0 }, { label: '30', value: 30 }, { label: '15', value: 15 } ], []);
            const [isSpinning, setIsSpinning] = useState(false); const [rotation, setRotation] = useState(0); const [result, setResult] = useState(null);
            const handleSpin = () => { if (spins <= 0 || isSpinning) return; if (tg) tg.HapticFeedback.impactOccurred('medium'); setIsSpinning(true); setResult(null); setSpins(prev => prev - 1); const spinAngle = Math.floor(Math.random() * 360) + 360 * 6; const newRotation = rotation + spinAngle; setRotation(newRotation); setTimeout(() => { const segmentAngle = 360 / segments.length; const finalAngle = newRotation % 360; const winningIndex = Math.floor((360 - finalAngle + segmentAngle / 2) % 360 / segmentAngle); const selectedSegment = segments[winningIndex]; setResult(selectedSegment); if (selectedSegment.value > 0) { updateBalance(selectedSegment.value); if (tg) tg.HapticFeedback.notificationOccurred('success'); } setIsSpinning(false); }, 4000); };
            const SvgWheel = ({ segments }) => { const radius = 100; const getCoords = (percent) => [Math.cos(2 * Math.PI * percent) * radius, Math.sin(2 * Math.PI * percent) * radius]; const segmentAngle = 1 / segments.length; return ( <g transform="rotate(-90)"> {segments.map((segment, i) => { const [startX, startY] = getCoords(i * segmentAngle); const [endX, endY] = getCoords((i + 1) * segmentAngle); const path = `M ${startX} ${startY} A ${radius} ${radius} 0 0 1 ${endX} ${endY} L 0 0`; const textAngleInRadians = (i + 0.5) * segmentAngle * 2 * Math.PI; const textX = Math.cos(textAngleInRadians) * radius * 0.65; const textY = Math.sin(textAngleInRadians) * radius * 0.65; const textRotation = (textAngleInRadians * 180 / Math.PI) + 90; return ( <g key={i}> <path d={path} fill={i % 2 === 0 ? "var(--color-green)" : "var(--color-primary)"} /> <g transform={`rotate(${textRotation} ${textX} ${textY})`}> <text x={textX} y={textY} className="wheel-svg-text">{segment.label}</text> </g> </g> ); })} </g> ); };
            return ( <div className="card"> <h2 className="section-title">Daily Spin Wheel</h2> <div className="spin-wheel-container"> <div className="spin-pointer"></div> <div className="spin-wheel" style={{ transform: `rotate(${rotation}deg)` }}> <svg viewBox="-105 -105 210 210" width="280" height="280"><SvgWheel segments={segments} /></svg> </div> </div> <button onClick={handleSpin} disabled={spins <= 0 || isSpinning} className="button button-primary">{isSpinning ? 'Spinning...' : `Spin Now (${spins} left)`}</button> {result && (<div className="spin-result">You landed on: <span className="spin-result-value">{result.label}</span> {result.value > 0 && ` (+${result.value} Gold)`} </div>)} </div> );
        };
        const GameSection = ({ launchGame }) => { /* ... */ 
            const games = [ { name: 'Backgammon', icon: 'üé≤', url: 'https://www.247backgammon.org/' }, { name: 'Chess', icon: '‚ôüÔ∏è', url: 'https://www.chess.com/play/computer' }, { name: 'Snakes & Ladders', icon: 'üêç', url: 'https://www.plays.org/snakes-and-ladders-multiplayer/' } ];
            return ( <div className="card"> <h2 className="section-title">Competitive Games</h2> <div className="item-list"> {games.map(game => ( <div key={game.name} className="list-item"> <div className="list-item-content"> <span className="list-item-icon">{game.icon}</span> <div className="list-item-details"> <p className="list-item-title">{game.name}</p> </div> </div> <button onClick={() => launchGame(game.url)} className="button button-green button-small">Play</button> </div> ))} </div> </div> );
        };
        const TaskSection = ({ updateBalance, tasks, setTasks }) => { /* ... */ 
             const handleClaim = (taskId) => { const task = tasks.find(t => t.id === taskId); if (!task || task.completed) return; updateBalance(task.reward); setTasks(prevTasks => prevTasks.map(t => t.id === taskId ? {...t, completed: true} : t)); };
            return ( <div className="card"> <h2 className="section-title">Tasks & Missions</h2> <div className="item-list"> {tasks.map(task => ( <div key={task.id} className={`list-item ${task.completed ? 'list-item-completed' : ''}`}> <div className="list-item-details"> <p className="list-item-title">{task.title}</p> <p className="list-item-subtitle">Reward: {task.reward} Gold</p> </div> {task.completed ? <span className="button-done">Done</span> : <button onClick={() => handleClaim(task.id)} className="button button-secondary button-small">Claim</button>} </div> ))} </div> </div> );
        };
        const FriendSection = ({ tg, user }) => { /* ... */
            const inviteLink = user ? `https://t.me/YourBot?start=${user.id}` : 'Loading...';
            const copyLink = () => { navigator.clipboard.writeText(inviteLink).then(() => { if(tg) tg.showAlert('Invite link copied!'); }); };
            return ( <div className="card"> <h2 className="section-title">Invite Friends</h2> <p style={{textAlign: 'center', color: 'var(--color-text-muted)'}}>Get an extra spin for each friend who joins!</p> <div className="invite-link-box"> <span className="invite-link-text">{inviteLink}</span> <button className="button button-primary button-small" onClick={copyLink}>Copy</button> </div> <div className="info-box"> <p style={{fontWeight: 'bold', fontSize: '1.2rem'}}>0 Friends</p> <p>Invited</p> </div> </div> );
        };
        const GameViewer = ({ url, onClose }) => { /* ... */ 
            return ( <div className="game-viewer"> <div className="game-viewer-header"> <button className="button button-small" style={{backgroundColor: "var(--color-red)"}} onClick={onClose}> Close Game </button> </div> <iframe className="game-viewer-iframe" src={url} title="Game"></iframe> </div> );
        };
        const WithdrawalSection = ({ tonConnectUI, wallet }) => { /* ... */
             const [page, setPage] = useState('main');
             const VIP_WALLET_ADDRESS = "UQA0JhVw0w34-YQZpFxxY6dxFLL5HJOQYXIJOzD4GUFWvMVR"; // IMPORTANT: Replace
             const VIP_FEE_TON = 0.5;
             const handleVipPayment = () => {
                if (!wallet) {
                    tonConnectUI.openModal(); // Ask user to connect wallet if not connected
                    return;
                }
                const transaction = { validUntil: Math.floor(Date.now() / 1000) + 600, messages: [ { address: VIP_WALLET_ADDRESS, amount: (VIP_FEE_TON * 1_000_000_000).toString(), } ] };
                tonConnectUI.sendTransaction(transaction).then(() => { alert("Transaction sent successfully!"); }).catch(err => { console.error(err); });
             };
             if (page === 'vip_info') {
                 return ( <div className="card" style={{textAlign: "center"}}> <h2 className="section-title">VIP Activation</h2> <p style={{color: "var(--color-text-muted)", margin: "0 auto 2rem auto", lineHeight: 1.6}}>Pay {VIP_FEE_TON} TON to activate your VIP status and unlock withdrawals.</p> <button className="button button-primary" onClick={handleVipPayment}>Pay with Wallet</button> <button className="button button-link" onClick={() => setPage('main')}>Back</button> </div> );
             }
             return ( <div className="card"> <h2 className="section-title">Withdrawals</h2> <div className="info-box"> <p>Free Withdrawal</p> <p style={{color: "var(--color-text-muted)", fontSize: "0.875rem"}}>Temporarily closed.</p> </div> <div className="info-box" style={{backgroundColor: "var(--color-primary-dark)"}}> <p style={{fontWeight: "bold"}}>VIP Withdrawal</p> <p style={{fontSize: "0.875rem"}}>Activate VIP to withdraw up to 30,000 Gold.</p> </div> <button className="button button-secondary" style={{marginTop: "1rem"}} onClick={() => setPage('vip_info')}>Activate VIP</button> </div> );
        };
        
        // ===================================================================
        // == THE MAIN APP AND WRAPPER (Corrected Initialization)
        // ===================================================================
        const App = () => {
            const tg = useTelegram();
            const [user, setUser] = useState(null);
            const [balance, setBalance] = useState(1950);
            const [spins, setSpins] = useState(3);
            const [tasks, setTasks] = useState([ { id: 1, title: 'Win 3 Games', reward: 100, completed: false }, { id: 2, title: 'Join news channel', reward: 500, completed: false } ]);
            const [activeTab, setActiveTab] = useState('spin');
            const [activeGameUrl, setActiveGameUrl] = useState(null);
            
            // This state holds the single instance of TonConnectUI
            const [tonConnectUI, setTonConnectUI] = useState(null);
            const [wallet, setWallet] = useState(null);

            useEffect(() => {
                if (tg) setUser(tg.initDataUnsafe?.user || { id: '12345', first_name: 'Guest' });
                
                // Initialize TonConnectUI only once
                const tc_instance = new TonConnectUI({
                    manifestUrl: 'https://gist.githubusercontent.com/siandree/036b236b25ac31f1d95361c8a1e80749/raw/b153b179373977593f009f4719623e9a7e80064f/gistfile1.txt', // Replace with your manifest URL
                    buttonRootId: 'ton-connect-button-container'
                });
                
                // Subscribe to wallet changes
                const unsubscribe = tc_instance.onStatusChange(walletInfo => {
                    setWallet(walletInfo);
                });
                
                setTonConnectUI(tc_instance);

                // Cleanup subscription on component unmount
                return () => unsubscribe();
            }, []);

            const updateBalance = useCallback((amount) => setBalance(prev => prev + amount), []);
            const launchGame = (url) => { updateBalance(-10); setActiveGameUrl(url); };
            const closeGame = () => { setActiveGameUrl(null); };

            const tabContent = {
                spin: <DailySpin spins={spins} setSpins={setSpins} updateBalance={updateBalance} tg={tg} />,
                games: <GameSection launchGame={launchGame} />,
                tasks: <TaskSection updateBalance={updateBalance} tasks={tasks} setTasks={setTasks} />,
                withdraw: <WithdrawalSection tonConnectUI={tonConnectUI} wallet={wallet} />,
                friends: <FriendSection tg={tg} user={user} />,
            };
            const navItems = [ { id: 'spin', icon: 'spinner', label: 'Spin' }, { id: 'games', icon: 'game', label: 'Games' }, { id: 'tasks', icon: 'task', label: 'Tasks' }, { id: 'withdraw', icon: 'wallet', label: 'Withdraw' }, { id: 'friends', icon: 'friends', label: 'Friends' }, ];

            return (
                <React.Fragment>
                    {activeGameUrl && <GameViewer url={activeGameUrl} onClose={closeGame} />}
                    <div style={{ display: activeGameUrl ? 'none' : 'block' }}>
                        <div className="app-container">
                            <header className="header">
                                <div className="header-left">
                                    <h1 className="header-title">GoldCoin</h1>
                                    <p className="header-subtitle">Welcome, {user?.first_name || ''}</p>
                                </div>
                                <div className="header-right">
                                     <div className="balance-display">
                                        <Icon name="coin" className="balance-icon" />
                                        <span className="balance-amount">{balance.toLocaleString()}</span>
                                    </div>
                                    <div id="ton-connect-button-container"></div>
                                </div>
                            </header>
                            <main>{tonConnectUI && tabContent[activeTab]}</main>
                        </div>
                        <div className="footer-spacer"></div>
                        <footer className="footer">
                            <nav className="nav">
                                {navItems.map(item => (
                                    <button key={item.id} onClick={() => setActiveTab(item.id)} className={`nav-button ${activeTab === item.id ? 'nav-button-active' : ''}`}>
                                        <Icon name={item.icon} className="nav-icon" />
                                        <span className="nav-label">{item.label}</span>
                                    </button>
                                ))}
                            </nav>
                        </footer>
                    </div>
                </React.Fragment>
            );
        };

        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(<App />);
    </script>
</body>
</html>